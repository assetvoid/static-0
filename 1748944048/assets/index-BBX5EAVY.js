import{r as S,j as p}from"./index-BpkY95s5.js";import{d as u}from"./index-CsSXPTiX.js";import{E as b,C,aj as m,T as j}from"./CommonWrapper-CDW1AQNa.js";import{F as y,W as v}from"./index-ykf0L6U2.js";import{_ as A,p as k,i as x,s as I,aB as W,a as s,cu as E,l as T,u as R}from"./index-NkqgFeUE.js";import{u as P}from"./background-subGX2Fx.js";import{t as B}from"./uploadUtil-DcPKYGZy.js";import"./methods-BkHYA0OL.js";import"./index-61irmPDo.js";const r={init(e){e.initialized||(e.initialized=!0,e.page.backgroundLayer.image=void 0,e.page.backgroundLayer.extra.backgroundColor="#ffffffff",P(e.page.backgroundLayer,e.page.width,e.page.height),e.stepStore.record("concatTemplateApplied"))},tryInit(e,a,t){if(!e.imageInfoList)return;const{length:i}=e.imageInfoList;let n=[...e.imageInfoList];const l=[];i>a.selectedTemplatePaneTotalCount&&(n=e.imageInfoList.slice(0,a.selectedTemplatePaneTotalCount)),n.forEach(g=>{const d=s();d.image=g,E(d),l.push(d)}),a.page.imageLayerList=l,r.updatePageAndLayerList(a,t),a.stepStore.stepCursor=-1,a.stepStore.record("concatTemplateApplied")},initAddImage(e,a,t){const i=[];let n=[...t];t.length>e.selectedTemplatePaneTotalCount&&(n=t.slice(0,e.selectedTemplatePaneTotalCount)),n.forEach(l=>{const g=r.createLayer(l);i.push(g)}),e.imageLayerList.push(...i),r.updatePageAndLayerList(e,a),e.isLoading=!1,e.stepStore.record("concatTemplateApplied")},addOrReplacePanelImageToPage(e,a,t){const i=[];t.forEach(n=>{const l=s();l.image=n,i.push(l)}),e.selectedTemplatePaneRestCount?e.page.imageLayerList=e.page.imageLayerList.concat(i):e.page.imageLayerList=i,r.updatePageAndLayerList(e,a),e.stepStore.record("CreatedLayers")},initPageBaseSize(e){const a=e.imageLayerList[0];a&&a.image&&(e.page.extra.baseWidth=a.image.naturalWidth,e.page.extra.baseHeight=a.image.naturalHeight)},updatePageSize(e){e.page.type?(e.page.width=e.page.extra.baseWidth,e.page.height=e.page.extra.baseHeight):(e.page.width=Math.floor(e.selectedTemplate.width),e.page.backgroundLayer.extra.backgroundColor=e.selectedTemplate.background)},initData(e){e.page.backgroundLayer.extra.backgroundColor="#ffffff",e.page.backgroundLayer.image=void 0,e.page.type||(e.page.gutterWidth=0,e.page.paddingWidth=0,e.page.borderRadiusPercent=0,e.page.extra.percentBorderRadius=0,e.page.extra.percentGutterWidth=0,e.page.extra.percentPaddingWidth=0),r.initTemplateSourceList(e)},initTemplateSourceList(e){e.imageLayerList.forEach((a,t)=>{a.extra&&a.extra.sourceList&&(a.extra.sourceList=[])})},createLayer(e){const a=W();a.imageSource=e.url,a.naturalWidth=e.width,a.naturalHeight=e.height;const t=s();return t.image=a,t},getTemplateSourceList(e,a,t){const i=[];return e.forEach(n=>{const l={id:n.id,url:n.url,width:n.width,height:n.height,left:n.left,top:n.top,positionType:n.positionType};n.positionType==="rightTop"&&(l.left+=a),n.positionType==="leftBottom"&&(l.top+=t),n.positionType==="rightBottom"&&(l.left+=a,l.top+=t),i.push(l)}),i},updateLayerListAndImage(e,a,t){if(r.updatePageSize(e),e.page.type){const{type:i,paddingWidth:n,gutterWidth:l}=e.page;let g=n,d=n;const c=1;e.imageLayerList.forEach(o=>{const f=i==="column"?e.page.extra.baseWidth:e.page.extra.baseHeight*c,L=i==="column"?e.page.extra.baseWidth/c:e.page.extra.baseHeight;o.width=f,o.height=L,o.top=g,o.left=d,i==="column"?g+=L+l:d+=f+l,t&&x(o),I(a,o)}),i==="column"?(e.page.height=g+n-l,e.page.width=e.page.extra.baseWidth+2*n):(e.page.width=d+n-l,e.page.height=e.page.extra.baseHeight+2*n)}else{const{photoList:i}=e.selectedTemplate;let n=0;e.imageLayerList.forEach((l,g)=>{let d=1;l.image&&(d=1),l.width=i[g].width;const c=i[g].height||i[g].width/d;l.height=c,l.left=i[g].left,n+=i[g].top,l.top=n,n+=c+i[g].bottom,i[g].sourceList.length&&l.extra&&(l.extra.sourceList=r.getTemplateSourceList(i[g].sourceList,l.width,l.height)),t&&x(l),I(a,l)}),e.page.height=Math.floor(n)}P(e.page.backgroundLayer,e.page.width,e.page.height)},updateTemplate({store:e,localStore:a,template:t,type:i}){k(a,{type:"clear"}),i||e.imageLayerList.splice(9);const n=e.selectedTemplateId;e.updateSelectedTemplateInfo(t),e.page.type=i,r.initData(e),e.selectedTemplate=t,r.updatePageAndLayerList(e,a),e.imageLayerList.length>0&&n!==e.selectedTemplateId&&e.stepStore.record("concatTemplateApplied")},updatePageAndLayerList(e,a){e.page.type&&r.initPageBaseSize(e),r.updateLayerListAndImage(e,a,!0)},shuffleLayerList(e,a){if(e.imageLayerList.length>1){r.initTemplateSourceList(e);const t=A.shuffle(e.imageLayerList);if(t[0].id===e.page.imageLayerList[0].id){const i=t.splice(0,1);t.push(i[0])}e.page.imageLayerList=t,r.updatePageAndLayerList(e,a)}}},w=u(()=>null);function h(e,a){r.updatePageAndLayerList(e,a)}function D(e,a,t){const i=e.imageLayerList.indexOf(t);i>-1&&e.imageLayerList.splice(i,1),r.updatePageAndLayerList(e,a)}function z(e,a,t,i){if(t===i)return;const n=T.cloneDeep(i.image);i.image=T.cloneDeep(t.image),t.image=n,e.page.type?r.updatePageAndLayerList(e,a):(r.initTemplateSourceList(e),r.updateLayerListAndImage(e,a,!0))}function H(e){const{localStore:a}=e;e.localStore.props.panels={getPanelBorderRadiusPercent(){return e.page.borderRadiusPercent},onPointerDownOnDeleteButton(){var t;(t=a.props.concat)==null||t.deleteConcatPanelImage(),e.stepStore.record("DeletedGridPanelImage")},async onDropWindowFilesIntoPanel(t,i){const n=await B({fileList:t,multiple:!1,maxCount:100,accept:["image/jpg","image/jpeg","image/png","image/heic"],maatType:"jigsaw",beforeUpload(){},showProgress:!0});if(!n.length)return;const l=[];n.forEach(d=>{l.push({url:d.url,height:d.height,width:d.width}),`${d.width}${d.height}${(d.size/1024).toFixed(2)}`});const{url:g}=n[0];await R(i,g),h(e,a),e.stepStore.record("UpdatedLayerImageURL")},onDropImageIntoPanel:t=>{t.nodeType==="IMAGE"&&(t.extra.backgroundColor="",t.image=e.collageInfo.leftAddImageInfo.dragImageInfo||void 0,t.extra.backgroundColor="",h(e,a)),e.stepStore.record("layerImageInterchanged")},onDropPanelImageIntoAnother(t,i){z(e,a,t,i),e.stepStore.record("layerImageInterchanged")}},a.props.concat={deleteConcatPanelImage(){e.selectedLayer&&D(e,a,e.selectedLayer)},onUpdatedConcatPanelImage(){h(e,a)}}}const F=u(({store:e})=>{const{localStore:a,stepStore:t}=e;return p.jsx(j,{stepStore:t,localStore:a,polygonStore:null,menu:null})});function O({concatStore:e,collageStore:a}){const t=e,{localStore:i,stepStore:n}=e;return S.useEffect(()=>(r.init(t),r.tryInit(a,t,t.localStore),H(t),()=>{t.localStore.props.panels=void 0,t.localStore.props.concat=void 0}),[]),p.jsxs("div",{style:{width:"100%",height:"100%",cursor:"default",backgroundColor:"var(--background--main)"},children:[p.jsx(b,{localStore:i,stepStore:n,polygonStore:null}),p.jsxs("div",{style:{display:"flex",height:"100%"},children:[p.jsx("div",{style:{flexShrink:0,position:"relative",height:"100%"},children:p.jsx(y,{type:"left",foldChanged:l=>{},children:p.jsx("div",{})})}),p.jsx("div",{style:{display:"flex",height:"100%",overflow:"hidden",flex:1},children:p.jsx(C,{vShow:t.imageLayerList.length>0,style:{position:"relative",flex:1,overflow:"hidden"},children:p.jsx(v,{shuffleImg:r.shuffleLayerList,navigator:p.jsx(m,{localStore:i,toolsContainer:null,watermarkView:p.jsx(w,{})}),localStore:i,addOrReplacePanelImageToPage:l=>{r.addOrReplacePanelImageToPage(t,i,l)},children:p.jsx(m,{localStore:i,toolsContainer:p.jsx(F,{store:t}),watermarkView:p.jsx(w,{})})})})}),p.jsx("div",{style:{flexShrink:0},children:t.imageLayerList.length>0?p.jsx("div",{style:{height:"100%"},children:p.jsx(y,{type:"right",foldChanged:l=>{},children:p.jsx("div",{})})}):null})]})]})}const N=u(O);export{N as default};
