import{bX as j,b0 as B,b1 as v,bY as D,bZ as U,b_ as $,b$ as q,a$ as f,l as b,c0 as N,c1 as G,aF as W,c2 as X,c3 as x,c4 as I,b3 as T,c5 as H,bq as V,c6 as Y,c7 as A,b2 as _,d as C,c8 as Z,c9 as J,ca as K,aN as S}from"./index-Dtau3K64.js";import{u as Q}from"./methods-DjtwcIIC.js";class ee{constructor(){this.map={},this.lastCheckedAt=0,this.map["0,0"]={index:[0,0],image:null,isDirty:!1,isUpdating:!1,contains:{layerIdMap:{}},scale:1,lastUsedAt:new Date().getTime()}}getTile(e){return this.map[e]||(this.map[e]={index:e.split(",").map(t=>parseInt(t,10)),image:null,scale:1,isDirty:!0,isUpdating:!1,contains:{layerIdMap:{}},lastUsedAt:new Date().getTime()}),this.map[e].lastUsedAt=new Date().getTime(),this.map[e]}hasDirtyVisibleTile(e){let t=!1;return e.visibleTileIdList.forEach(s=>{this.map[s].isDirty&&(t=!0)}),t}forEach(e){Object.keys(this.map).forEach(t=>{e(this.map[t])})}getTileCount(){return Object.keys(this.map).length}tryDeleteUselessTiles(e){const t=new Date().getTime();t-this.lastCheckedAt<10*1e3||(this.lastCheckedAt=t,Object.keys(this.map).forEach(s=>{var l;if(e.visibleTileIdList.indexOf(s)>-1)return;const a=this.map[s];t-a.lastUsedAt>30*1e3&&((l=a.image)==null||l.delete(),delete this.map[s])}))}clear(){Object.keys(this.map).forEach(e=>{var s;(s=this.map[e].image)==null||s.delete(),delete this.map[e]})}}const k=1;function te(i){const{fileData:e}=i,t=Math.min(i.canvasElement.width,i.canvasElement.height)/window.devicePixelRatio;return e.scale<.05?Math.min(100,t):e.scale<.1?Math.min(250,t):e.scale<k?Math.min(500,t):1e4}function ie(i){const{fileData:e}=i;let t=e.viewport.x,s=e.viewport.y;const a=[],l=[];for(;t<=e.viewport.x+e.viewport.width+i.tileSize;)a.push(Math.floor(t/i.tileSize)),t+=i.tileSize;for(;s<=e.viewport.y+e.viewport.height+i.tileSize;)l.push(Math.floor(s/i.tileSize)),s+=i.tileSize;const o=[];return a.forEach(r=>{l.forEach(n=>{o.push(`${r},${n}`)})}),o}function L({context:i,imageUrl:e}){b.forEach(i.fileData.snapshotMap,(t,s)=>{if(t.contains.imageUrlMap[e]){const a=f(i.fileData,s);a&&(N(i.fileData,a),i.tileMap.forEach(l=>{l.contains.layerIdMap[s]&&(l.isDirty=!0)}))}})}function R(i,e){b.forEach(i.fileData.snapshotMap,(t,s)=>{if(t.contains.layerIdMap[e.id]){const a=f(i.fileData,s);a&&(N(i.fileData,a),i.tileMap.forEach(l=>{l.contains.layerIdMap[s]&&(l.isDirty=!0)}))}}),i.tileMap.forEach(t=>{t.contains.layerIdMap[e.id]&&(t.isDirty=!0)})}function y(i,e){const{fileData:t}=i;R(i,e);const s=j(t,e);if(s){const l=B(i.fileData,s);if(l){const o=v({fileData:t,Raptor:i.Raptor,layer:e,instanceChain:[],options:{}}).withShadow,r=l.getRelativeTransform();o.forEach(n=>{const d=D(r,n);n.x=d.x,n.y=d.y}),i.tileMap.forEach(n=>{const d=U({left:n.index[0]*i.tileSize/t.scale,top:n.index[1]*i.tileSize/t.scale,width:i.tileSize/t.scale,height:i.tileSize/t.scale,rotate:0});$(d,o)&&(n.isDirty=!0)})}}q(t,e).forEach(l=>{const o=t.layerAssetsMap[l];o&&Object.keys(o.instanceMap).forEach(r=>{const n=f(t,r);n&&y(i,n)})})}async function M({context:i,Raptor:e,fileData:t,fontName:s,updateDirty:a}){const l=await t.fontStore.ensureFont({fontID:s,Raptor:e,fontProvider:t.fontProvider});return a&&G(t,o=>{if(o.nodeType==="TEXT"&&o.fontName.fullname===s){const r=t.localStore.getLayer(o.id);r&&r.nodeType==="TEXT"&&Q({localStore:t.localStore,layer:r,text:o.textData.characters,step:W(),instanceChain:[]}),R(i,o)}}),l}async function z({context:i,Raptor:e,fileData:t,normalLayer:s}){const a=f(t,s.id);if(!a)return;const l=t.layerAssetsMap[a.id];if((a.nodeType==="GROUP"||X(a)||a.nodeType==="SYMBOL"||a.nodeType==="SECTION")&&((a.nodeType==="FRAME"||a.nodeType==="SYMBOL")&&a.fillPaints.forEach(o=>{o.type==="IMAGE"&&t.assetMap.ensureAsset(o.image.imageSource).then(()=>{L({context:i,imageUrl:o.image.imageSource})})}),s.children&&s.children.forEach(o=>{z({context:i,Raptor:e,normalLayer:o,fileData:t})})),a.nodeType==="IMAGE"&&a.image){const o=a.image.imageSource;t.assetMap.ensureAsset(o).then(()=>{L({context:i,imageUrl:o})})}a.nodeType==="TEXT"&&(l.paragraphManager={paragraph:null},M({context:i,Raptor:e,fileData:t,fontName:a.fontName.fullname,updateDirty:!0})),s.nodeType,t.dirty=!0}function se({context:i,Raptor:e,fileData:t,action:s}){s.type==="UpdateScale"?(t.scale=s.payload.scale,t.viewport.x=s.payload.x,t.viewport.y=s.payload.y,i.tileSize=te(i)):s.type==="UpdateNodes"&&(console.log(s),Object.keys(s.payload.layerMap).forEach(a=>{const l=s.payload.layerMap[a];l.life&&(l.life.$value&&l.life.$value.type==="createChildren"&&b.map(l.life.$value.newLayers,(o,r)=>{var d;(d=l.life)!=null&&d.$value&&z({context:i,Raptor:e,fileData:t,normalLayer:o});const n=f(t,r);n&&y(i,n)}),l.life.$value&&l.life.$value.type==="delete"&&(f(t,a)||t.localStore.props.getCurrentPage())&&b.map(l.life.$value.deletedNodes,(r,n)=>{const d=f(t,n);d&&(y(i,d),x(t,d))}))}),Object.keys(s.payload.layerMap).forEach(a=>{const l=s.payload.layerMap[a],o=f(t,a);o&&(l.fontName&&o.nodeType==="TEXT"&&M({context:i,Raptor:e,fileData:t,fontName:o.fontName.fullname}),y(i,o));const r=t.layerAssetsMap[a];r&&r.markDirty()}),t.localStore.renderCount+=1)}function ae(i,e,t,s){const a=s.localStore.props.getCurrentPage();if(!a)throw new Error;const l=[];i.visibleTileIdList=ie(i);const o=new Date().getTime();return i.visibleTileIdList.forEach(r=>{var d,p;const n=i.tileMap.getTile(r);if(n.scale!==s.scale||n.isDirty){if((d=n.image)==null||d.delete(),n.image=null,n.isDirty=!0,new Date().getTime()-o>100)return;l.push(r),e.clear(t.TRANSPARENT),e.save(),e.scale(window.devicePixelRatio,window.devicePixelRatio),e.translate(-n.index[0]*i.tileSize,-n.index[1]*i.tileSize),n.contains.layerIdMap={},I(e,t,s,a.children,{useSnapshot:!0,bounds:T({x:n.index[0]*i.tileSize/s.scale,y:n.index[1]*i.tileSize/s.scale,width:i.tileSize/s.scale,height:i.tileSize/s.scale}),tile:n,instanceChain:[]}),n.image=((p=i.surface)==null?void 0:p.makeImageSnapshot(t.LTRBiRect(0,0,i.tileSize*window.devicePixelRatio,i.tileSize*window.devicePixelRatio)))||null,e.restore(),n.scale=s.scale,n.isDirty=!1}}),l}function O(i,e,t,s){t.nodeType==="SECTION"?t.children.forEach(a=>{O(i,e,a,s)}):V(t)&&Y(i.fileData,t)===null&&ne({canvas:e,layer:t,context:i,surface:s})}function re({canvas:i,context:e,currentPage:t}){const{Raptor:s}=e;i.clear(s.TRANSPARENT),i.save(),t.children.forEach(a=>{O(e,i,a,e.surface)}),i.restore()}function ne({canvas:i,layer:e,context:t,surface:s}){const{Raptor:a,fileData:l}=t;i.clear(a.TRANSPARENT),i.save(),i.scale(window.devicePixelRatio,window.devicePixelRatio);const o=e.nodeType==="INSTANCE"?[e]:[],r=v({Raptor:a,fileData:l,layer:e,instanceChain:o,options:{}}).withShadow,n=r[3].x-r[0].x,d=r[1].y-r[0].y,p=t.canvasElement.width,c=t.canvasElement.height;let h=1;(n*h*window.devicePixelRatio>p||d*h*window.devicePixelRatio>c)&&(console.warn("Huge layer"),h=Math.min(p/window.devicePixelRatio/n,c/window.devicePixelRatio/d)),i.translate(-r[0].x*h,-r[0].y*h);const m=A(t.fileData,e,null);m.contains.layerIdMap={},m.contains.imageUrlMap={},_(i,a,{...l,scale:h,doScale:u=>u*h},e,{useSnapshot:!1,bounds:T({x:-1e5/h,y:-1e5/h,width:2e5/h,height:2e5/h}),tile:null,snapshot:m,instanceChain:o});const g=s.makeImageSnapshot(a.LTRBiRect(0,0,n*h*window.devicePixelRatio,d*h*window.devicePixelRatio));g&&A(t.fileData,e,g),i.clear(a.TRANSPARENT),i.restore()}function oe(i,e,t,s){const a=s.localStore.props.getCurrentPage();if(!a)throw new Error;re({canvas:e,context:i,currentPage:a});const l=ae(i,e,t,s);e.clear(t.TRANSPARENT),e.save(),e.scale(window.devicePixelRatio,window.devicePixelRatio),e.translate(-s.viewport.x,-s.viewport.y),s.localStore.isFullyFunctional&&s.scale<k?(i.visibleTileIdList.forEach(o=>{const r=i.tileMap.getTile(o);if(r.image){const n=new t.Paint;n.setAntiAlias(!0),n.setStyle(t.PaintStyle.Fill),n.setColor(t.BLUE),n.setBlendMode(t.BlendMode.DstATop),e.save(),e.translate(r.index[0]*i.tileSize,r.index[1]*i.tileSize),e.drawImageRect(r.image,t.LTRBRect(0,0,r.image.width(),r.image.height()),t.LTRBRect(0,0,i.tileSize+1,i.tileSize+1),n),e.restore(),n.delete()}}),s.localStore.isFullyFunctional&&l.forEach(o=>{const r=i.tileMap.getTile(o),n=new t.Paint;n.deleteLater(),n.setAntiAlias(!0),n.setStyle(t.PaintStyle.Stroke),n.setStrokeWidth(1),n.setColor(t.BLUE),n.setAlphaf(.5),e.save(),e.translate(r.index[0]*i.tileSize,r.index[1]*i.tileSize),e.drawRect(t.XYWHRect(0,0,i.tileSize,i.tileSize),n),e.restore()}),i.tileMap.hasDirtyVisibleTile(i)===!1&&console.log("clean")):I(e,t,s,a.children,{useSnapshot:!1,bounds:T({x:s.viewport.x/s.scale,y:s.viewport.y/s.scale,width:s.viewport.width/s.scale,height:s.viewport.height/s.scale}),tile:null,instanceChain:[]}),H({canvas:e,fileData:s,options:{enableDrawResizer:!0}}),e.restore()}function ce({children:i}){return{id:C(),nodeType:"DOCUMENT",name:"Document",phase:"CREATED",children:i,editInfo:{userId:"",createdAt:0,lastEditedAt:0}}}function he({children:i}){return{id:C(),nodeType:"CANVAS",phase:"CREATED",name:"",width:100,height:100,fillPaints:[{type:"SOLID",opacity:1,visible:!0,blendMode:"NORMAL",color:{r:1,g:1,b:1,a:1}}],backgroundEnabled:!0,children:i,opacity:1,blendMode:"PASS_THROUGH",editInfo:{userId:"",createdAt:new Date().getTime(),lastEditedAt:new Date().getTime()}}}async function ue({path:i,localStore:e,elem:t,width:s,height:a,fontStore:l}){return Z({locateFile:r=>`${i}${r}`}).then(r=>{var g;t.width=s*window.devicePixelRatio,t.height=a*window.devicePixelRatio;const n={Raptor:r,canvasElement:t,localStore:e,dirty:!0,scale:1,viewport:{x:0,y:0,width:s,height:a,pointer:{x:0,y:0}},assetMap:new K(r),overlayFont:null,fontStore:l,fontProvider:r.TypefaceFontProvider.Make(),layerMap:{},layerAssetsMap:{},snapshotMap:{},doScale(u){return n.scale*u},renderState:{isDrawing:!1},overlay$$:[],hoveredTarget:null,paragraphManager:{activeParagraph:null}},d=r.GetWebGLContext(t),p=r.MakeWebGLContext(d),c={gr:p,Raptor:r,fileData:n,canvasElement:t,offscreenWebglCanvas:document.createElement("canvas"),surface:r.MakeOnScreenGLSurface(p,t.width,t.height,r.ColorSpace.SRGB),tileSize:500,visibleTileIdList:[],canvasBackground:"#F5F5F5",tileMap:new ee};M({context:c,Raptor:r,fileData:n,fontName:"SourceHanSansCN-Regular"}).then(u=>{n.overlayFont=new r.Font(u.typeface)}),e.props.doAction=u=>{se({Raptor:r,fileData:n,action:u,context:c}),n.dirty=!0};const h=new J(c);e.getFigma=()=>h,e.getNormalLayerList=()=>{var u;return((u=e.figma)==null?void 0:u.topLevelLayerList)||[]};function m(u){var E;if(n.dirty||c.tileMap.hasDirtyVisibleTile(c)){n.dirty=!1,n.renderState.isDrawing=!0;try{oe(c,u,r,n)}catch(F){console.error(F)}c.tileMap.tryDeleteUselessTiles(c),console.log(c.tileMap.getTileCount()),n.renderState.isDrawing=!1}(E=c.surface)==null||E.requestAnimationFrame(m)}return(g=c.surface)==null||g.requestAnimationFrame(m),c})}function w(i){S.error(i)}const P={works:"works"};class pe{constructor({name:e}){this.db=void 0,this.name=e}assert(){if(!this.db)throw S.error("本地数据库不存在，请刷新重试"),new Error("DB does not exist!")}async initDB(){if(!window.indexedDB)throw w("IndexedDB not supported"),new Error;const e=await window.indexedDB.databases();let t=0;return e.forEach(s=>{s.name===this.name&&typeof s.version=="number"&&(t=s.version)}),new Promise((s,a)=>{const l=window.indexedDB.open(this.name,t+1);l.onerror=o=>{w("Failed to connect with db"),console.log(o),console.error("Why didn't you allow my web app to use IndexedDB?!"),a()},l.onupgradeneeded=o=>{console.log(o);const r=o.target.result;console.log(r),r&&(r.objectStoreNames.contains("fonts")===!1&&r.createObjectStore("fonts",{keyPath:"id"}),r.objectStoreNames.contains("models")===!1&&r.createObjectStore("models",{keyPath:"id"}),r.objectStoreNames.contains(P.works)===!1&&r.createObjectStore(P.works,{keyPath:"id"}).createIndex("updatedAt","updatedAt"),this.db=r),setTimeout(()=>{s("")},300)}})}async getObjectInternal(e){return this.assert(),new Promise((t,s)=>{if(this.db){const a=this.db.transaction(e.tableName,"readonly").objectStore(e.tableName).get(e.id);a.transaction.oncomplete=()=>{t(a.result)},a.transaction.onerror=()=>{w("Failed to add model"),s()},a.transaction.onabort=()=>{s()}}else s()})}async getModel(e){return this.assert(),await this.getObjectInternal({tableName:"models",id:e})}async getFont(e){return this.assert(),await this.getObjectInternal({tableName:"fonts",id:e})}async getWork(e){return this.assert(),await this.getObjectInternal({tableName:"works",id:e})}async deleteObject(e){return this.assert(),new Promise((t,s)=>{if(this.db){const a=this.db.transaction(e.tableName,"readwrite").objectStore(e.tableName).delete(e.id);a.transaction.oncomplete=()=>{t("")},a.transaction.onerror=()=>{w("Failed to delete model"),s()}}})}async putObject(e){return e.tableName==="works"&&(e.obj.createdAt=new Date().getTime(),e.obj.updatedAt=new Date().getTime()),new Promise((t,s)=>{if(this.db){const a=this.db.transaction(e.tableName,"readwrite").objectStore(e.tableName).put(e.obj);a.transaction.oncomplete=()=>{t("")},a.transaction.onerror=()=>{w(`Failed to add object to ${e.tableName}`),s()}}else s()})}async addObject(e){return this.assert(),e.tableName==="works"&&(e.obj.createdAt=new Date().getTime(),e.obj.updatedAt=new Date().getTime()),new Promise((t,s)=>{if(this.db){const a=this.db.transaction(e.tableName,"readwrite").objectStore(e.tableName).add(e.obj);a.transaction.oncomplete=()=>{t("")},a.transaction.onerror=()=>{w(`Failed to add object to ${e.tableName}`),s()}}else s()})}async getWorkList(){return this.assert(),new Promise((e,t)=>{if(this.db){const s=this.db.transaction("works","readwrite").objectStore("works").index("updatedAt").openCursor(null,"prev"),a=[];s.onsuccess=l=>{const o=l.target.result;if(!o)e(a);else{const r=o.value;console.log(r),r?(a.push({id:r.id,thumbnail:r.thumbnail}),console.log(o.direction),o.continue()):e(a)}},s.transaction.onerror=()=>{S.error("打开作品列表失败"),t()}}else t()})}}export{pe as D,he as a,ce as b,ue as i,M as l};
