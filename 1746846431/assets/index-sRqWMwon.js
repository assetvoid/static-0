import{r as T,j as n}from"./index-BpkY95s5.js";import{d as y}from"./index-CsSXPTiX.js";import{a as E,i as m,cn as I,p as M,l as u,s as P}from"./index-BcyvOYN4.js";import{E as R,ak as x,T as W}from"./CommonWrapper-Ds17FSTE.js";import{F as A,W as F}from"./index-D1Z5iDOa.js";import{R as H}from"./index-CXvtScxP.js";import{M as O}from"./Menu-BRw_I4MR.js";import{s as z}from"./style-t4wHHbRu.js";import"./index-Dt5PJkyQ.js";import"./uploadUtil-BSOrutXu.js";import"./index-eMbJ-FI5.js";function V(t){const e=[];return t.forEach(()=>{const i=E();i.extra.shapeMask.maskType=1,e.push(i)}),e}function q({pageWidth:t,pageHeight:e,layerList:i,imageInfoList:s}){const l=t*.3;let h=0;const o=i.length;i.forEach((a,g)=>{if(a.nodeType==="IMAGE"&&!a.image){const d=s[h],p=1;d.height=l,d.width=l*p,a.image=d,a.height=d.height,a.width=d.width,m(a),I(a),a.left=(.4+.2/o*g)*t-a.width/2,a.top=(.4+.2/o*g)*e-a.height/2,h+=1}})}function D({pageWidth:t,pageHeight:e,layerList:i,imageInfoList:s}){const l=t-40,h=e-40;let o=0;const a=s.length,g=Math.floor(Math.sqrt(a)),d=Math.ceil(a/g),p=l/g,S=l/(g+1),k=h/(d+1);i.forEach(r=>{if(r.nodeType==="IMAGE"&&!r.image){const c=s[o],v=1;c.height=p,c.width=p*v,r.image=c,r.height=c.height,r.width=c.width,m(r),I(r);const L=parseFloat(String((o+1)/g)),f=parseInt(String(L),10),b=L-f>0?f+1:f,C=(o+1)%g||g;r.top=b*k-r.height/2+20,r.left=C*S-r.width/2+20,r.rotate=Math.floor(Math.random()*60-30),o+=1}})}async function G(t,e){if(e.initialized===!0){j(t,e),e.stepStore.stepCursor=-1,e.stepStore.record("concatTemplateApplied");return}N(t,e),e.stepStore.record("AppliedFreeTemplate"),e.initialized=!0}function N(t,e){e.page.backgroundLayer.image=void 0,e.page.backgroundLayer.extra.backgroundColor="#ffffffff",e.page.backgroundLayer.width=e.page.width,e.page.backgroundLayer.height=e.page.height,e.page.normalLayerList=[],j(t,e)}function w(t,e){let i=[];i=V(e),t.page.normalLayerList=[...t.normalLayerList,...i],B(t,e)}function B(t,e){t.selectedTemplateId==="0"?q({pageWidth:t.page.width,pageHeight:t.page.height,layerList:t.normalLayerList,imageInfoList:e}):D({pageWidth:t.page.width,pageHeight:t.page.height,layerList:t.normalLayerList,imageInfoList:e})}function j(t,e){e.page.normalLayerList=[],M(e.localStore,{type:"clear"}),t.imageInfoList&&w(e,t.imageInfoList)}function J(t,e){w(t,e),t.stepStore.record("AddedLayerImage")}const K=y(({store:t})=>{const{localStore:e,stepStore:i,collageInfo:s}=t;return n.jsx(W,{stepStore:i,localStore:e,polygonStore:null,menu:n.jsx(O,{collageInfo:s,localStore:e,stepStore:i,layerImageCreate:{}}),customOverlays:e.leafNormalLayerList.length<1?n.jsx("div",{style:{position:"absolute",left:0,top:0,width:t.page.width*e.getPageScale(),height:t.page.height*e.getPageScale(),borderRadius:"4px",overflow:"hidden"}}):void 0})}),oe=y(({collageStore:t})=>{const e=t.freeCollageStore,{localStore:i,stepStore:s,collageInfo:l}=e;T.useEffect(()=>{G(t,e)},[]);const h=()=>{if(e.imageLayerList.length<2)return;const o=u.shuffle(u.cloneDeep(e.imageLayerList));if(o[0].id===e.imageLayerList[0].id){const a=o.splice(0,1);o.push(a[0])}for(const a in o)e.imageLayerList[a]&&(e.imageLayerList[a].image=o[a].image,e.imageLayerList[a].extra.backgroundColor=o[a].extra.backgroundColor,m(e.imageLayerList[a]),P(i,e.imageLayerList[a]))};return n.jsxs("div",{style:{height:"100%",backgroundColor:z.backgroundColor,display:"flex"},children:[n.jsx(R,{localStore:i,stepStore:s,polygonStore:null}),n.jsx("div",{style:{position:"fixed",right:0,top:0,zIndex:1e3},children:n.jsx(H,{localStore:i,stepStore:s,collageInfo:l})}),n.jsx("div",{style:{flexShrink:0},children:n.jsx(A,{type:"left",foldChanged:()=>{},children:n.jsx("div",{})})}),n.jsx("div",{style:{flex:1,position:"relative",overflow:"hidden"},children:n.jsx(F,{shuffleImg:h,navigator:n.jsx(x,{localStore:i,toolsContainer:null,watermarkView:null}),localStore:i,addOrReplacePanelImageToPage:o=>{J(e,o)},children:n.jsx(x,{localStore:i,toolsContainer:n.jsx(K,{store:e}),watermarkView:null})})}),n.jsx("div",{style:{height:"100%"}})]})});export{oe as default};
