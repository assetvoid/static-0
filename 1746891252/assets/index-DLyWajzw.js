import{e8 as G,e9 as C,o as v,dU as B,ea as W,l as X,ci as M,dV as $,ce as R,cf as U,cg as O,eb as Q}from"./index-I7DZV1Kp.js";import{g as q}from"./textImage-Dn89lm85.js";import"./index-CsSXPTiX.js";import"./index-BpkY95s5.js";const z={},j=G();function D(r){const t=[];return r.forEach(e=>{e.nodeType==="GROUP"?t.push(...D(e.children)):t.push(e)}),t}class it{constructor(t,e){this.progressRatio=0,this.progressPercentage=0;const{PIXI:i}=C;this.layerList=Y(t),this.promiseList=[],this.errorCallback=a=>{throw a},this.app=new i.Application({width:t.page.width,height:t.page.height,backgroundAlpha:0,antialias:!0,forceCanvas:!0,autoStart:!1}),this.borderRadiusPercent=t.page.borderRadiusPercent,this.width=t.page.width,this.height=t.page.height,this.paddingWidth=t.page.paddingWidth||0,this.hasWatermark=!!e.hasWatermark,this.queueCallback=[],this.isRended=!1,this.isAllowDownLoad=!0,this.progress=0,this.syncData=e.syncData||{progressPercentage:0},this.globalContainer=new i.Container,this.app.stage.addChild(this.globalContainer),this.backgroundColorContainer=new i.Container;const n=new i.Graphics;n.clear().beginFill(16777215,1).drawRect(0,0,this.width,this.height).endFill(),this.backgroundColorContainer.addChild(n),this.backgroundColorContainer.visible=!1,this.globalContainer.addChild(this.backgroundColorContainer),this.contentContainer=new i.Container,this.globalContainer.addChild(this.contentContainer),t.type,t.type==="ConcatCollage"&&(this.paddingWidth=0),(t.type==="PosterCollage"||t.type==="FreeCollage")&&(this.paddingWidth=0)}async start(){this.progressRatio=100/(J(this.layerList)+3+(this.hasWatermark?1:0)),this.progressPercentage=0,this.progress+=1,this.updatedProgress(),this.layerList.forEach((t,e)=>{t.nodeType==="IMAGE"&&this.initImageLayer(t,e===0),t.nodeType==="TEXT"&&this.initTextLayer(t)}),this.hasWatermark&&this.initWatermark(),await Promise.all(this.promiseList).then(()=>{this.isRended=!0,this.queueCallback.length&&this.executeQueue()}).catch(t=>{this.errorCallback(t)})}hideWatermark(){this.hasWatermark&&this.collectQueue(()=>{this.watermarkSprite.visible=!1})}showWatermark(){this.hasWatermark&&this.collectQueue(()=>{this.watermarkSprite.visible=!0})}cancelDownLoad(){this.isAllowDownLoad=!1}downLoad(t){return new Promise((e,i)=>{this.errorCallback=n=>{i(n)},this.collectQueue(async()=>{if(!this.isAllowDownLoad){this.errorCallback(new Error("cancel"));return}this.progress+=1,this.updatedProgress();try{const n=this.extract({extractType:"canvas",imageType:t.format});if(!this.isAllowDownLoad){this.errorCallback(new Error("cancel"));return}const a=await _(n,t.format,t.quality);if(!this.isAllowDownLoad){this.errorCallback(new Error("cancel"));return}this.progress+=1,this.updatedProgress();const s=t.format==="image/jpeg"?"jpg":"png";N(URL.createObjectURL(a),`${t.name||"下载"}.${s}`),this.progressPercentage=0,this.updatedProgress(),e(n)}catch(n){this.errorCallback(n)}})})}collectQueue(t){this.queueCallback.push(()=>Promise.all([t()])),this.isRended&&this.queueCallback.length===1&&this.executeQueue()}executeQueue(){const t=this.queueCallback[0];t&&t().then(()=>{this.queueCallback.shift(),this.executeQueue()})}extract({extractType:t,imageType:e,quality:i,sizeRatio:n}){const{PIXI:a}=C;let s=1;if(j==="qq"){const l=Math.max(this.width,this.height);e==="image/jpeg"&&l>8e3&&(s=.9)}let o=s;n&&(o*=n),e==="image/jpeg"?this.backgroundColorContainer.visible=!0:this.backgroundColorContainer.visible=!1;const h=new a.BaseRenderTexture({width:this.width*o,height:this.height*o}),c=new a.RenderTexture(h);return this.app.renderer.render(this.globalContainer,{renderTexture:c,clear:!1,transform:new a.Matrix(o,0,0,o,0,0)}),t==="@image"?this.app.renderer.plugins.extract.image(c,e,i):t==="base64"?this.app.renderer.plugins.extract.base64(c,e,i):this.app.renderer.plugins.extract.canvas(c)}syncToModel(){this.syncData.progressPercentage=this.progressPercentage}updatedProgress(){}initWatermark(){const{PIXI:t}=C,e=new t.Container;this.globalContainer.addChild(e),this.promiseList.push(P(z).then(i=>{this.progress+=1,this.updatedProgress(),this.isAllowDownLoad&&(this.watermarkSprite=new t.TilingSprite(i,this.width,this.height),this.watermarkSprite.tileScale.x=.5,this.watermarkSprite.tileScale.y=.5,e.addChild(this.watermarkSprite))}).catch(i=>{throw i}))}initGridCollageBackgroundLayer(t){const{PIXI:e}=C,i=new e.Container;this.contentContainer.addChild(i);const n=new e.Graphics;if(n.clear().beginFill(16777215).drawRect(0,0,this.width,this.height).endFill(),i.addChild(n),i.mask=n,t.backgroundColor){const a=new e.Graphics,s=v(t.backgroundColor,"6hex");a.clear().beginFill(parseInt(s.color.replace(/#/,""),16),s.opacity).drawRect(0,0,this.width,this.height).endFill(),i.addChild(a)}if(t.image&&t.image.url){const a=new e.Container;i.addChild(a),this.promiseList.push(P(t.image.url).then(s=>{if(this.progress+=1,this.updatedProgress(),!!this.isAllowDownLoad&&t.image){if(t.image.type==="cover"){const o=new e.Sprite(s);o.anchor.set(.5);const h=Math.max(this.width/o.width,this.height/o.height);o.scale.set(h),o.x=this.width/2,o.y=this.height/2,a.addChild(o)}if(t.image.type==="repeat"){const o=new e.TilingSprite(s,this.width,this.height);a.addChild(o)}}}).catch(s=>{throw s}))}}initBackgroundLayer(t){const{PIXI:e}=C,i=new e.Container;if(this.contentContainer.addChild(i),t.backgroundColor){const n=new e.Graphics,a=v(t.backgroundColor,"6hex");n.clear().beginFill(parseInt(a.color.replace(/#/,""),16),a.opacity).drawRect(0,0,this.width,this.height).endFill(),i.addChild(n)}}initImageLayer(t,e=!1){const{PIXI:i}=C,n=e?0:this.paddingWidth,a=e?0:this.borderRadiusPercent,s=new i.Container;this.contentContainer.addChild(s),s.x=t.left+n,s.y=t.top+n;const o=new i.Container;s.addChild(o);const h=new i.Container,c=new i.Graphics;if(V(c,0,0,t.width,t.height,B(t,a)),h.addChild(c),h.mask=c,t.image){const g=new i.Container,l=[],m=t.image.imageSource;if(m){const d=new i.Container,w=new i.Container;g.addChild(w),w.addChild(d);const u=new i.Graphics;u.clear().beginFill(16777215).drawRect(0,0,t.width,t.height).endFill(),w.addChild(u),w.mask=u,l.push(H(t.id,m).then(f=>{if(!this.isAllowDownLoad||!t.image)return;const p=new i.Sprite(f);d.addChild(p),p.width=t.image.width,p.height=t.image.height,d.width=t.image.width,d.height=t.image.height,d.pivot.x=d.width/2,d.pivot.y=d.height/2,d.x=t.width/2,d.y=t.height/2,p.x=t.image.imageX,p.y=t.image.imageY,t.image.flipV&&(p.scale.y*=-1,p.anchor.y=1),t.image.flipH&&(p.scale.x*=-1,p.anchor.x=1),typeof t.image.rotate=="number"&&(d.angle=t.image.rotate),typeof t.image.opacity=="number"&&(d.alpha=t.image.opacity)}).catch(f=>{throw f}))}if(t.extra.shapeMask.maskURL){const d=new i.Container;g.addChild(d),l.push(P(t.extra.shapeMask.maskURL,2).then(w=>{if(!this.isAllowDownLoad)return;const u=new i.Sprite(w);u.blendMode=i.BLEND_MODES.DST_OUT;const f=Math.min(t.width/u.width,t.height/u.height);u.anchor.set(.5),u.scale.set(f),u.x=t.width/2,u.y=t.height/2;const p=new i.Container,k=new i.Graphics;p.addChild(k),p.addChild(u),k.clear().beginFill(16777215).drawRect(0,0,t.width,t.height).endFill();const L=this.app.renderer.plugins.extract.canvas(p),T=new i.BaseTexture(L),x=new i.Texture(T),b=new i.Sprite(x);b.blendMode=i.BLEND_MODES.DST_OUT,d.addChild(b)}).catch(w=>{throw w}))}this.promiseList.push(Promise.all(l).then(()=>{if(this.progress+=1,this.updatedProgress(),!this.isAllowDownLoad||!t.image)return;if(t.extra.shapeMask.maskURL){const p=new i.BaseRenderTexture({width:t.width-.1,height:t.height-.1}),k=new i.RenderTexture(p);this.app.renderer.render(g,{renderTexture:k,clear:!1});const L=this.app.renderer.plugins.extract.canvas(k),T=new i.BaseTexture(L),x=new i.Texture(T),b=new i.Sprite(x);h.addChild(b)}else h.addChild(g);const d=this.app.renderer.plugins.extract.canvas(h),w=new i.BaseTexture(d),u=new i.Texture(w),f=new i.Sprite(u);o.addChild(f),o.pivot.x=t.width/2,o.pivot.y=t.height/2,o.x=t.width/2,o.y=t.height/2,o.angle=t.rotate}).catch(d=>{throw d}))}else if(t.extra.backgroundGradient||t.extra.backgroundColor){const g=new i.Graphics;if(h.addChild(g),t.extra.backgroundGradient){const{colors:u,angle:f}=t.extra.backgroundGradient,{x0:p,y0:k,x1:L,y1:T}=W(t.width,t.height,f),x=document.createElement("canvas");x.width=t.width,x.height=t.height;const b=x.getContext("2d"),S=b.createLinearGradient(p,k,L,T);u.forEach(E=>{const{color:F,value:A}=E;S.addColorStop(A,F)}),b.fillStyle=S,b.fillRect(0,0,t.width,t.height);const I=i.Texture.from(x);g.clear().beginTextureFill({texture:I}).drawRect(0,0,t.width,t.height).endFill()}else{const u=v(t.extra.backgroundColor,"6hex");g.clear().beginFill(parseInt(u.color.replace(/#/,""),16),u.opacity).drawRect(0,0,t.width,t.height).endFill()}const l=this.app.renderer.plugins.extract.canvas(h),m=new i.BaseTexture(l),d=new i.Texture(m),w=new i.Sprite(d);o.addChild(w)}if(t.extra&&t.extra.sourceList){const g=new i.Container;s.addChild(g),t.extra.sourceList.forEach(l=>{this.promiseList.push(P(l.url).then(m=>{if(this.progress+=1,this.updatedProgress(),!this.isAllowDownLoad)return;const d=new i.Sprite(m);d.width=l.width,d.height=l.height,d.x=l.left,d.y=l.top,g.addChild(d)}).catch(m=>{throw m}))})}}initTextLayer(t){const{PIXI:e}=C,i=new e.Container;this.contentContainer.addChild(i);const n=new e.Container;i.addChild(n);const a=t.fontSize/2;i.x=t.left-a,i.y=t.top-a;const s=()=>new Promise((o,h)=>{(async()=>{try{const c=await K(t),g=document.createElement("canvas");g.width=c.width*2,g.height=c.height*2;const l=g.getContext("2d");l==null||l.drawImage(c,0,0,g.width,g.height);const m=new e.BaseTexture(g),d=new e.Texture(m);o(d)}catch(c){h(c)}})()});this.promiseList.push(s().then(o=>{if(this.progress+=1,this.updatedProgress(),!this.isAllowDownLoad)return;const h=new e.Sprite(o);h.scale.set(.5),n.addChild(h),n.pivot.x=(t.width+a)/2,n.pivot.y=(t.height+a)/2,n.x=(t.width+a)/2,n.y=(t.height+a)/2,n.angle=t.rotate}).catch(o=>{throw o}))}}const H=(r,t)=>{const{PIXI:e}=C;return new Promise((i,n)=>{try{setTimeout(()=>{const a=document.getElementById($(r));if(a){const s=new e.BaseTexture(a),o=new e.Texture(s);i(o)}else P(t).then(s=>{i(s)})})}catch(a){n(a)}})},P=(r,t)=>{const e=new Image;return e.setAttribute("crossOrigin","Anonymous"),e.src=M(r),new Promise((i,n)=>{e.onload=()=>{let a=e;if(t&&t!==1){const h=document.createElement("canvas");h.width=e.width*t,h.height=e.height*t;const c=h.getContext("2d");c&&(c.drawImage(e,0,0,h.width,h.height),a=h)}const s=new C.PIXI.BaseTexture(a),o=new C.PIXI.Texture(s);i(o)},e.onerror=a=>{n(a)}})};function N(r,t){const e=document.createElement("a");e.download=t||"",e.href=r,document.body.appendChild(e),e.click(),e.remove()}function _(r,t,e){return new Promise((i,n)=>{try{r.toBlob(a=>{a?i(a):n(new Error("overSize"))},t,e)}catch(a){n(a)}})}function V(r,t,e,i,n,a){const s=Math.min(i/2,n/2,a);r.beginFill(),r.arc(t+s,e+s,s,Math.PI,Math.PI*3/2),r.lineTo(i-s+t,e),r.arc(i-s+t,s+e,s,Math.PI*3/2,Math.PI*2),r.lineTo(i+t,n+e-s),r.arc(i-s+t,n-s+e,s,0,Math.PI*1/2),r.lineTo(s+t,n+e),r.arc(s+t,n-s+e,s,Math.PI*1/2,Math.PI),r.endFill()}function Y(r){if(!r)return[];const t=X.cloneDeep(r),e=t.page.imageLayerList;return t.type==="GridCollage"&&e.unshift(t.page.backgroundLayer),t.type==="ConcatCollage"&&e.unshift(r.page.backgroundLayer),(t.type==="PosterCollage"||t.type==="FreeCollage"||t.type==="common")&&(e.unshift(t.page.backgroundLayer),e.push(...D(t.page.normalLayerList))),e}function J(r){let t=0;return r.forEach(e=>{e.nodeType==="IMAGE"&&(t+=e.image?1:0,t+=e.extra&&e.extra.sourceList?e.extra.sourceList.length:0),e.nodeType==="TEXT"&&(t+=1)}),t}async function K(r){return new Promise((t,e)=>{const i=q(r.id);if(i){t(i);return}setTimeout(async()=>{try{const n=`<div style="${R(U(r))}">${r.textData.characters}</div>`,a=`<div style="${R(O(r))}">${r.textData.characters}</div>`,s=document.getElementById(Q(r.fontName.fullname)),o=`data:image/svg+xml;charset=utf-8,
        <svg xmlns="http://www.w3.org/2000/svg" width="${r.width+r.fontSize}" height="${r.height+r.fontSize}">
          <foreignObject width="100%" height="100%">
            <div xmlns='http://www.w3.org/1999/xhtml' style="padding-left: ${r.fontSize/2}px;padding-top: ${r.fontSize/2}px;">
              <style type="text/css">body,div{padding:0;margin:0}${s?s.innerHTML:""}</style>
              <div style="position: relative;">
                ${n}
                ${a}
              </div>
            </div>
          </foreignObject>
        </svg>`,h=new Image;h.setAttribute("crossOrigin","Anonymous"),h.src=M(o),h.onload=()=>{t(h)},h.onerror=c=>{e(c)}}catch(n){e(n)}},300)})}export{it as Render,_ as canvasToBlob,N as downLoad,Y as getDownloadLayerList,P as getTexture,K as textLoadFontImage};
