import{r as T,j as n}from"./index-BpkY95s5.js";import{d as y}from"./index-CsSXPTiX.js";import{a as E,i as f,cs as I,p as M,l as u,s as P}from"./index-wwEj6H2r.js";import{E as R,aj as x,T as W}from"./CommonWrapper-Czd500b7.js";import{F as A,W as F}from"./index-CeT2dLal.js";import{R as H}from"./index-jhr-W3PK.js";import{M as O}from"./Menu-BFX17y8k.js";import{s as z}from"./style-t4wHHbRu.js";import"./methods-BkHYA0OL.js";import"./index-C9yx2fHG.js";import"./uploadUtil-DMy6Z8cC.js";import"./index-n1aYOa7O.js";function V(t){const e=[];return t.forEach(()=>{const a=E();a.extra.shapeMask.maskType=1,e.push(a)}),e}function q({pageWidth:t,pageHeight:e,layerList:a,imageInfoList:s}){const l=t*.3;let h=0;const o=a.length;a.forEach((i,g)=>{if(i.nodeType==="IMAGE"&&!i.image){const d=s[h],c=1;d.height=l,d.width=l*c,i.image=d,i.height=d.height,i.width=d.width,f(i),I(i),i.left=(.4+.2/o*g)*t-i.width/2,i.top=(.4+.2/o*g)*e-i.height/2,h+=1}})}function D({pageWidth:t,pageHeight:e,layerList:a,imageInfoList:s}){const l=t-40,h=e-40;let o=0;const i=s.length,g=Math.floor(Math.sqrt(i)),d=Math.ceil(i/g),c=l/g,S=l/(g+1),v=h/(d+1);a.forEach(r=>{if(r.nodeType==="IMAGE"&&!r.image){const p=s[o],b=1;p.height=c,p.width=c*b,r.image=p,r.height=p.height,r.width=p.width,f(r),I(r);const L=parseFloat(String((o+1)/g)),m=parseInt(String(L),10),k=L-m>0?m+1:m,C=(o+1)%g||g;r.top=k*v-r.height/2+20,r.left=C*S-r.width/2+20,r.rotate=Math.floor(Math.random()*60-30),o+=1}})}async function G(t,e){if(e.initialized===!0){j(t,e),e.stepStore.stepCursor=-1,e.stepStore.record("concatTemplateApplied");return}N(t,e),e.stepStore.record("AppliedFreeTemplate"),e.initialized=!0}function N(t,e){e.page.backgroundLayer.image=void 0,e.page.backgroundLayer.extra.backgroundColor="#ffffffff",e.page.backgroundLayer.width=e.page.width,e.page.backgroundLayer.height=e.page.height,e.page.normalLayerList=[],j(t,e)}function w(t,e){let a=[];a=V(e),t.page.normalLayerList=[...t.normalLayerList,...a],B(t,e)}function B(t,e){t.selectedTemplateId==="0"?q({pageWidth:t.page.width,pageHeight:t.page.height,layerList:t.normalLayerList,imageInfoList:e}):D({pageWidth:t.page.width,pageHeight:t.page.height,layerList:t.normalLayerList,imageInfoList:e})}function j(t,e){e.page.normalLayerList=[],M(e.localStore,{type:"clear"}),t.imageInfoList&&w(e,t.imageInfoList)}function J(t,e){w(t,e),t.stepStore.record("AddedLayerImage")}const K=y(({store:t})=>{const{localStore:e,stepStore:a,collageInfo:s}=t;return n.jsx(W,{stepStore:a,localStore:e,polygonStore:null,menu:n.jsx(O,{collageInfo:s,localStore:e,stepStore:a,layerImageCreate:{}}),customOverlays:e.leafNormalLayerList.length<1?n.jsx("div",{style:{position:"absolute",left:0,top:0,width:t.page.width*e.getPageScale(),height:t.page.height*e.getPageScale(),borderRadius:"4px",overflow:"hidden"}}):void 0})}),ne=y(({collageStore:t})=>{const e=t.freeCollageStore,{localStore:a,stepStore:s,collageInfo:l}=e;T.useEffect(()=>{G(t,e)},[]);const h=()=>{if(e.imageLayerList.length<2)return;const o=u.shuffle(u.cloneDeep(e.imageLayerList));if(o[0].id===e.imageLayerList[0].id){const i=o.splice(0,1);o.push(i[0])}for(const i in o)e.imageLayerList[i]&&(e.imageLayerList[i].image=o[i].image,e.imageLayerList[i].extra.backgroundColor=o[i].extra.backgroundColor,f(e.imageLayerList[i]),P(a,e.imageLayerList[i]))};return n.jsxs("div",{style:{height:"100%",backgroundColor:z.backgroundColor,display:"flex"},children:[n.jsx(R,{localStore:a,stepStore:s,polygonStore:null}),n.jsx("div",{style:{position:"fixed",right:0,top:0,zIndex:1e3},children:n.jsx(H,{localStore:a,stepStore:s,collageInfo:l})}),n.jsx("div",{style:{flexShrink:0},children:n.jsx(A,{type:"left",foldChanged:()=>{},children:n.jsx("div",{})})}),n.jsx("div",{style:{flex:1,position:"relative",overflow:"hidden"},children:n.jsx(F,{shuffleImg:h,navigator:n.jsx(x,{localStore:a,toolsContainer:null,watermarkView:null}),localStore:a,addOrReplacePanelImageToPage:o=>{J(e,o)},children:n.jsx(x,{localStore:a,toolsContainer:n.jsx(K,{store:e}),watermarkView:null})})}),n.jsx("div",{style:{height:"100%"}})]})});export{ne as default};
